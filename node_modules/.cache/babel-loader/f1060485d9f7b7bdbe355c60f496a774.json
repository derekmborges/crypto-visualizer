{"ast":null,"code":"\"use strict\";\n/* eslint-disable @typescript-eslint/member-ordering */\n\n/* eslint-disable @typescript-eslint/no-unsafe-return */\n\n/* eslint-disable @typescript-eslint/no-unsafe-call */\n\n/* eslint-disable @typescript-eslint/no-unsafe-member-access */\n\n/* eslint-disable @typescript-eslint/no-unsafe-assignment */\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.UpbitClient = void 0;\n\nconst BasicClient_1 = require(\"../BasicClient\");\n\nconst Level2Point_1 = require(\"../Level2Point\");\n\nconst Level2Snapshots_1 = require(\"../Level2Snapshots\");\n\nconst NotImplementedFn_1 = require(\"../NotImplementedFn\");\n\nconst Ticker_1 = require(\"../Ticker\");\n\nconst Trade_1 = require(\"../Trade\");\n\nclass UpbitClient extends BasicClient_1.BasicClient {\n  constructor() {\n    let {\n      wssPath = \"wss://api.upbit.com/websocket/v1\",\n      watcherMs\n    } = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    super(wssPath, \"Upbit\", undefined, watcherMs);\n    this._sendSubCandles = NotImplementedFn_1.NotImplementedFn;\n    this._sendUnsubCandles = NotImplementedFn_1.NotImplementedFn;\n    this._sendSubLevel2Updates = NotImplementedFn_1.NotImplementedFn;\n    this._sendUnsubLevel2Updates = NotImplementedFn_1.NotImplementedFn;\n    this._sendSubLevel3Snapshots = NotImplementedFn_1.NotImplementedFn;\n    this._sendUnsubLevel3Snapshots = NotImplementedFn_1.NotImplementedFn;\n    this._sendSubLevel3Updates = NotImplementedFn_1.NotImplementedFn;\n    this._sendUnsubLevel3Updates = NotImplementedFn_1.NotImplementedFn;\n    this.hasTickers = true;\n    this.hasTrades = true;\n    this.hasLevel2Snapshots = true;\n    this.debouceTimeoutHandles = new Map();\n    this.debounceWait = 200;\n  }\n\n  _sendSubTicker() {\n    this._debounce(\"sub-ticker\", () => {\n      if (!this._wss) return;\n      const codes = Array.from(this._tickerSubs.keys());\n\n      this._wss.send(JSON.stringify([{\n        ticket: \"tickers\"\n      }, {\n        type: \"ticker\",\n        codes: codes\n      }]));\n    });\n  }\n\n  _sendUnsubTicker() {\n    this._debounce(\"unsub-ticker\", () => {\n      if (!this._wss) return;\n      const codes = Array.from(this._tickerSubs.keys());\n\n      this._wss.send(JSON.stringify([{\n        ticket: \"tickers\"\n      }, {\n        type: \"ticker\",\n        codes: codes\n      }]));\n    });\n  }\n\n  _sendSubTrades() {\n    this._debounce(\"sub-trades\", () => {\n      if (!this._wss) return;\n      const codes = Array.from(this._tradeSubs.keys());\n\n      this._wss.send(JSON.stringify([{\n        ticket: \"trades\"\n      }, {\n        type: \"trade\",\n        codes: codes\n      }]));\n    });\n  }\n\n  _sendUnsubTrades() {\n    this._debounce(\"unsub-trades\", () => {\n      if (!this._wss) return;\n      const codes = Array.from(this._tradeSubs.keys());\n\n      this._wss.send(JSON.stringify([{\n        ticket: \"trades\"\n      }, {\n        type: \"trade\",\n        codes: codes\n      }]));\n    });\n  }\n\n  _sendSubLevel2Snapshots() {\n    this._debounce(\"sub-l2snapshots\", () => {\n      if (!this._wss) return;\n      const codes = Array.from(this._level2SnapshotSubs.keys());\n\n      this._wss.send(JSON.stringify([{\n        ticket: \"quotation\"\n      }, {\n        type: \"orderbook\",\n        codes: codes\n      }]));\n    });\n  }\n\n  _sendUnsubLevel2Snapshots() {\n    this._debounce(\"unsub-l2snapshots\", () => {\n      if (!this._wss) return;\n      const codes = Array.from(this._level2SnapshotSubs.keys());\n\n      this._wss.send(JSON.stringify([{\n        ticket: \"quotation\"\n      }, {\n        type: \"orderbook\",\n        codes: codes\n      }]));\n    });\n  }\n\n  _debounce(type, fn) {\n    clearTimeout(this.debouceTimeoutHandles.get(type));\n    this.debouceTimeoutHandles.set(type, setTimeout(fn, this.debounceWait));\n  }\n\n  _onMessage(raw) {\n    const rawStr = raw.toString(\"utf8\");\n    const msgs = JSON.parse(rawStr.replace(/:(\\d+\\.{0,1}\\d+)(,|\\})/g, ':\"$1\"$2'));\n\n    this._processsMessage(msgs);\n  }\n\n  _processsMessage(msg) {\n    // console.log(msg);\n    // trades\n    if (msg.type === \"trade\") {\n      const market = this._tradeSubs.get(msg.code);\n\n      if (!market) return;\n\n      const trade = this._constructTradesFromMessage(msg, market);\n\n      this.emit(\"trade\", trade, market);\n      return;\n    } // tickers\n\n\n    if (msg.type === \"ticker\") {\n      const market = this._tickerSubs.get(msg.code);\n\n      if (!market) return;\n\n      const ticker = this._constructTicker(msg, market);\n\n      this.emit(\"ticker\", ticker, market);\n      return;\n    } // l2 updates\n\n\n    if (msg.type === \"orderbook\") {\n      const market = this._level2SnapshotSubs.get(msg.code);\n\n      if (!market) return;\n\n      const snapshot = this._constructLevel2Snapshot(msg, market);\n\n      this.emit(\"l2snapshot\", snapshot, market);\n      return;\n    }\n  }\n\n  _constructTicker(msg, market) {\n    /*\n    { type: 'ticker',\n    code: 'KRW-BTC',\n    opening_price: '3980000.00000000',\n    high_price: '4017000.00000000',\n    low_price: '3967000.00000000',\n    trade_price: '3982000.0',\n    prev_closing_price: '3981000.00000000',\n    acc_trade_price: '10534309614.237530000',\n    change: 'RISE',\n    change_price: '1000.00000000',\n    signed_change_price: '1000.00000000',\n    change_rate: '0.0002511932',\n    signed_change_rate: '0.0002511932',\n    ask_bid: 'ASK',\n    trade_volume: '0.01562134',\n    acc_trade_volume: '2641.03667958',\n    trade_date: '20190213',\n    trade_time: '132020',\n    trade_timestamp: '1550064020000',\n    acc_ask_volume: '1232.55205784',\n    acc_bid_volume: '1408.48462174',\n    highest_52_week_price: '14149000.00000000',\n    highest_52_week_date: '2018-02-20',\n    lowest_52_week_price: '3562000.00000000',\n    lowest_52_week_date: '2018-12-15',\n    trade_status: null,\n    market_state: 'ACTIVE',\n    market_state_for_ios: null,\n    is_trading_suspended: false,\n    delisting_date: null,\n    market_warning: 'NONE',\n    timestamp: '1550064020393',\n    acc_trade_price_24h: null,\n    acc_trade_volume_24h: null,\n    stream_type: 'SNAPSHOT' }\n    */\n    const {\n      opening_price,\n      trade_price,\n      acc_trade_volume,\n      change_rate,\n      change_price,\n      low_price,\n      high_price,\n      timestamp\n    } = msg;\n    return new Ticker_1.Ticker({\n      exchange: this.name,\n      base: market.base,\n      quote: market.quote,\n      timestamp: parseInt(timestamp),\n      last: trade_price,\n      open: opening_price,\n      high: high_price,\n      low: low_price,\n      volume: acc_trade_volume,\n      quoteVolume: (acc_trade_volume * trade_price).toFixed(8),\n      change: change_price,\n      changePercent: change_rate\n    });\n  }\n\n  _constructTradesFromMessage(datum, market) {\n    /*\n    {\n    \"type\":\"trade\",\n    \"code\":\"KRW-BTC\",\n    \"timestamp\":1549443263262,\n    \"trade_date\":\"2019-02-06\",\n    \"trade_time\":\"08:54:23\",\n    \"trade_timestamp\":1549443263000,\n    \"trade_price\":3794000.0,\n    \"trade_volume\":0.00833522,\n    \"ask_bid\":\"BID\",\n    \"prev_closing_price\":3835000.00000000,\n    \"change\":\"FALL\",\"change_price\":41000.00000000,\n    \"sequential_id\":1549443263000001,\n    \"stream_type\":\"REALTIME\"}\n    */\n    const {\n      trade_timestamp,\n      trade_price,\n      trade_volume,\n      ask_bid,\n      sequential_id\n    } = datum;\n    const side = ask_bid === \"BID\" ? \"buy\" : \"sell\";\n    return new Trade_1.Trade({\n      exchange: this.name,\n      base: market.base,\n      quote: market.quote,\n      tradeId: sequential_id,\n      side: side,\n      unix: parseInt(trade_timestamp),\n      price: trade_price,\n      amount: trade_volume\n    });\n  }\n\n  _constructLevel2Snapshot(msg, market) {\n    /*\n    { type: 'orderbook',\n    code: 'KRW-BTT',\n    timestamp: 1549465903782,\n    total_ask_size: 1550925205.4196181,\n    total_bid_size: 2900599205.9702206,\n    orderbook_units:\n    [ { ask_price: 1.04,\n    bid_price: 1.03,\n    ask_size: 185206052.57158336,\n    bid_size: 354443748.7514278 },\n    ...\n    { ask_price: 1.13,\n    bid_price: 0.94,\n    ask_size: 198013382.3803366,\n    bid_size: 267304509.61145836 } ],\n    stream_type: 'SNAPSHOT' }\n    */\n    const asks = msg.orderbook_units.map(p => new Level2Point_1.Level2Point(s(p.ask_price), s(p.ask_size)));\n    const bids = msg.orderbook_units.map(p => new Level2Point_1.Level2Point(s(p.bid_price), s(p.bid_size)));\n    return new Level2Snapshots_1.Level2Snapshot({\n      exchange: this.name,\n      base: market.base,\n      quote: market.quote,\n      timestampMs: parseInt(msg.timestamp),\n      asks,\n      bids\n    });\n  }\n\n}\n\nexports.UpbitClient = UpbitClient;\n\nfunction s(v) {\n  if (typeof v === \"number\") {\n    return v.toFixed(8);\n  } else {\n    return v;\n  }\n}","map":{"version":3,"sources":["/Users/Derek/workspace/crypto-visualizer/node_modules/ccxws/src/exchanges/UpbitClient.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/member-ordering */\n/* eslint-disable @typescript-eslint/no-unsafe-return */\n/* eslint-disable @typescript-eslint/no-unsafe-call */\n/* eslint-disable @typescript-eslint/no-unsafe-member-access */\n/* eslint-disable @typescript-eslint/no-unsafe-assignment */\n\nimport { BasicClient } from \"../BasicClient\";\nimport { ClientOptions } from \"../ClientOptions\";\nimport { Level2Point } from \"../Level2Point\";\nimport { Level2Snapshot } from \"../Level2Snapshots\";\nimport { NotImplementedFn } from \"../NotImplementedFn\";\nimport { Ticker } from \"../Ticker\";\nimport { Trade } from \"../Trade\";\n\nexport class UpbitClient extends BasicClient {\n    public debouceTimeoutHandles: Map<string, NodeJS.Timeout>;\n    public debounceWait: number;\n\n    constructor({ wssPath = \"wss://api.upbit.com/websocket/v1\", watcherMs }: ClientOptions = {}) {\n        super(wssPath, \"Upbit\", undefined, watcherMs);\n\n        this.hasTickers = true;\n        this.hasTrades = true;\n        this.hasLevel2Snapshots = true;\n\n        this.debouceTimeoutHandles = new Map();\n        this.debounceWait = 200;\n    }\n\n    protected _sendSubTicker() {\n        this._debounce(\"sub-ticker\", () => {\n            if (!this._wss) return;\n            const codes = Array.from(this._tickerSubs.keys());\n            this._wss.send(\n                JSON.stringify([{ ticket: \"tickers\" }, { type: \"ticker\", codes: codes }]),\n            );\n        });\n    }\n\n    protected _sendUnsubTicker() {\n        this._debounce(\"unsub-ticker\", () => {\n            if (!this._wss) return;\n            const codes = Array.from(this._tickerSubs.keys());\n            this._wss.send(\n                JSON.stringify([{ ticket: \"tickers\" }, { type: \"ticker\", codes: codes }]),\n            );\n        });\n    }\n\n    protected _sendSubTrades() {\n        this._debounce(\"sub-trades\", () => {\n            if (!this._wss) return;\n            const codes = Array.from(this._tradeSubs.keys());\n            this._wss.send(JSON.stringify([{ ticket: \"trades\" }, { type: \"trade\", codes: codes }]));\n        });\n    }\n\n    protected _sendUnsubTrades() {\n        this._debounce(\"unsub-trades\", () => {\n            if (!this._wss) return;\n            const codes = Array.from(this._tradeSubs.keys());\n            this._wss.send(JSON.stringify([{ ticket: \"trades\" }, { type: \"trade\", codes: codes }]));\n        });\n    }\n\n    protected _sendSubLevel2Snapshots() {\n        this._debounce(\"sub-l2snapshots\", () => {\n            if (!this._wss) return;\n            const codes = Array.from(this._level2SnapshotSubs.keys());\n            this._wss.send(\n                JSON.stringify([{ ticket: \"quotation\" }, { type: \"orderbook\", codes: codes }]),\n            );\n        });\n    }\n\n    protected _sendUnsubLevel2Snapshots() {\n        this._debounce(\"unsub-l2snapshots\", () => {\n            if (!this._wss) return;\n            const codes = Array.from(this._level2SnapshotSubs.keys());\n            this._wss.send(\n                JSON.stringify([{ ticket: \"quotation\" }, { type: \"orderbook\", codes: codes }]),\n            );\n        });\n    }\n\n    protected _sendSubCandles = NotImplementedFn;\n    protected _sendUnsubCandles = NotImplementedFn;\n    protected _sendSubLevel2Updates = NotImplementedFn;\n    protected _sendUnsubLevel2Updates = NotImplementedFn;\n    protected _sendSubLevel3Snapshots = NotImplementedFn;\n    protected _sendUnsubLevel3Snapshots = NotImplementedFn;\n    protected _sendSubLevel3Updates = NotImplementedFn;\n    protected _sendUnsubLevel3Updates = NotImplementedFn;\n\n    protected _debounce(type: string, fn: () => void) {\n        clearTimeout(this.debouceTimeoutHandles.get(type));\n        this.debouceTimeoutHandles.set(type, setTimeout(fn, this.debounceWait));\n    }\n\n    protected _onMessage(raw: Buffer) {\n        const rawStr = raw.toString(\"utf8\");\n        const msgs: any = JSON.parse(rawStr.replace(/:(\\d+\\.{0,1}\\d+)(,|\\})/g, ':\"$1\"$2'));\n        this._processsMessage(msgs);\n    }\n\n    protected _processsMessage(msg: any) {\n        // console.log(msg);\n\n        // trades\n        if (msg.type === \"trade\") {\n            const market = this._tradeSubs.get(msg.code);\n            if (!market) return;\n\n            const trade = this._constructTradesFromMessage(msg, market);\n            this.emit(\"trade\", trade, market);\n            return;\n        }\n\n        // tickers\n        if (msg.type === \"ticker\") {\n            const market = this._tickerSubs.get(msg.code);\n            if (!market) return;\n\n            const ticker = this._constructTicker(msg, market);\n            this.emit(\"ticker\", ticker, market);\n            return;\n        }\n\n        // l2 updates\n        if (msg.type === \"orderbook\") {\n            const market = this._level2SnapshotSubs.get(msg.code);\n            if (!market) return;\n\n            const snapshot = this._constructLevel2Snapshot(msg, market);\n            this.emit(\"l2snapshot\", snapshot, market);\n            return;\n        }\n    }\n\n    protected _constructTicker(msg, market) {\n        /*\n{ type: 'ticker',\n  code: 'KRW-BTC',\n  opening_price: '3980000.00000000',\n  high_price: '4017000.00000000',\n  low_price: '3967000.00000000',\n  trade_price: '3982000.0',\n  prev_closing_price: '3981000.00000000',\n  acc_trade_price: '10534309614.237530000',\n  change: 'RISE',\n  change_price: '1000.00000000',\n  signed_change_price: '1000.00000000',\n  change_rate: '0.0002511932',\n  signed_change_rate: '0.0002511932',\n  ask_bid: 'ASK',\n  trade_volume: '0.01562134',\n  acc_trade_volume: '2641.03667958',\n  trade_date: '20190213',\n  trade_time: '132020',\n  trade_timestamp: '1550064020000',\n  acc_ask_volume: '1232.55205784',\n  acc_bid_volume: '1408.48462174',\n  highest_52_week_price: '14149000.00000000',\n  highest_52_week_date: '2018-02-20',\n  lowest_52_week_price: '3562000.00000000',\n  lowest_52_week_date: '2018-12-15',\n  trade_status: null,\n  market_state: 'ACTIVE',\n  market_state_for_ios: null,\n  is_trading_suspended: false,\n  delisting_date: null,\n  market_warning: 'NONE',\n  timestamp: '1550064020393',\n  acc_trade_price_24h: null,\n  acc_trade_volume_24h: null,\n  stream_type: 'SNAPSHOT' }\n     */\n\n        const {\n            opening_price,\n            trade_price,\n            acc_trade_volume,\n            change_rate,\n            change_price,\n            low_price,\n            high_price,\n            timestamp,\n        } = msg;\n\n        return new Ticker({\n            exchange: this.name,\n            base: market.base,\n            quote: market.quote,\n            timestamp: parseInt(timestamp),\n            last: trade_price,\n            open: opening_price,\n            high: high_price,\n            low: low_price,\n            volume: acc_trade_volume,\n            quoteVolume: (acc_trade_volume * trade_price).toFixed(8),\n            change: change_price,\n            changePercent: change_rate,\n        });\n    }\n\n    protected _constructTradesFromMessage(datum, market) {\n        /*\n      {\n       \"type\":\"trade\",\n       \"code\":\"KRW-BTC\",\n       \"timestamp\":1549443263262,\n       \"trade_date\":\"2019-02-06\",\n       \"trade_time\":\"08:54:23\",\n       \"trade_timestamp\":1549443263000,\n       \"trade_price\":3794000.0,\n       \"trade_volume\":0.00833522,\n       \"ask_bid\":\"BID\",\n       \"prev_closing_price\":3835000.00000000,\n       \"change\":\"FALL\",\"change_price\":41000.00000000,\n       \"sequential_id\":1549443263000001,\n       \"stream_type\":\"REALTIME\"}\n    */\n\n        const { trade_timestamp, trade_price, trade_volume, ask_bid, sequential_id } = datum;\n\n        const side = ask_bid === \"BID\" ? \"buy\" : \"sell\";\n\n        return new Trade({\n            exchange: this.name,\n            base: market.base,\n            quote: market.quote,\n            tradeId: sequential_id,\n            side: side,\n            unix: parseInt(trade_timestamp),\n            price: trade_price,\n            amount: trade_volume,\n        });\n    }\n\n    protected _constructLevel2Snapshot(msg, market) {\n        /*\n{ type: 'orderbook',\n  code: 'KRW-BTT',\n  timestamp: 1549465903782,\n  total_ask_size: 1550925205.4196181,\n  total_bid_size: 2900599205.9702206,\n  orderbook_units:\n   [ { ask_price: 1.04,\n       bid_price: 1.03,\n       ask_size: 185206052.57158336,\n       bid_size: 354443748.7514278 },\n...\n     { ask_price: 1.13,\n       bid_price: 0.94,\n       ask_size: 198013382.3803366,\n       bid_size: 267304509.61145836 } ],\n  stream_type: 'SNAPSHOT' }\n    */\n        const asks = msg.orderbook_units.map(p => new Level2Point(s(p.ask_price), s(p.ask_size)));\n        const bids = msg.orderbook_units.map(p => new Level2Point(s(p.bid_price), s(p.bid_size)));\n        return new Level2Snapshot({\n            exchange: this.name,\n            base: market.base,\n            quote: market.quote,\n            timestampMs: parseInt(msg.timestamp),\n            asks,\n            bids,\n        });\n    }\n}\n\nfunction s(v: any) {\n    if (typeof v === \"number\") {\n        return v.toFixed(8);\n    } else {\n        return v;\n    }\n}\n"]},"metadata":{},"sourceType":"script"}